#!/bin/sh

# $Id: uname,v 1.15 2004/03/27 14:01:45 peter Exp $

. $NTTOOLS

S=
R=
M=
N=
V=
P=

for a in "$@"
do
  case "$a" in
    --version)
      ver=`echo "$Revision: 1.15 $" |sed -e 's/.* \(.*\) .*/\1/'`
      echo "Fake NT uname version $ver by Fredrik Hubinette and others"
      exit 0
    ;;

    --help)
      echo "Usage: uname [-a] [-m] [-n] [-p] [-r] [-s] [-v]"
      exit 0
    ;;

    --all)  S=yes ; R=yes ; M=yes ; N=yes ; V=yes ; P=yes ;;
    --machine) M=yes ;;
    --nodename) N=yes ;;
    --sysname) S=yes ;;
    --processor) P=yes ;;
    --revision) R=yes ;;

    --*)
      echo "Unknown option $a"
      exit 1
    ;;

    -*)
      case "$a" in
        *m*) M=yes ;;
      esac

      case "$a" in
        *n*) N=yes ;;
      esac

      case "$a" in
        *p*) P=yes ;;
      esac

      case "$a" in
        *s*) S=yes ;;
      esac

      case "$a" in
        *r*) R=yes ;;
      esac

      case "$a" in
        *v*) V=yes ;;
      esac

      case "$a" in
        *a*) M=yes ; N=yes ; S=yes ; V=yes ;;
      esac
    ;;
      
  esac
done

if [ X"$M$N$S$P$R$V" = X ]; then
  S=yes
fi

OUTPUT=

if [ "$S$R$V" = "" ]; then :; else
  # Note: The resulting string starts with a line feed,
  #       and then something like:
  # Windows NT Version 4.0
  #       or
  # Microsoft Windows XP [Version 5.1.2600]
  RAW_VERSION="`sprsh cmd /c ver`"
fi

if [ X$S = Xyes ]; then
  # System name.
  # Note that the first '.' either matches ' ' or '['.
  SYSNAME="`echo $RAW_VERSION|sed -e 's/.Version.*//;s/^Microsoft//'`"
  # Perform whitespace adjustmant.
  OUTPUT="$OUTPUT `echo $SYSNAME|tr ' ' '_'`"
fi

if [ X$N = Xyes ]; then
  # Node name.
  OUTPUT="$OUTPUT $NTHOST"
fi

if [ X$R = Xyes -o X$V = Xyes ]; then
  # Release number or Version number.
  OUTPUT="$OUTPUT `echo $RAW_VERSION|sed -e's/[^0-9.]*//g'`"
  # If there are more than one processor, apply "-smp"
  NUMPROCS="`getntenv NUMBER_OF_PROCESSORS`"
  if [ ! -z "$NUMPROCS" ] && [ $NUMPROCS -gt 1 ]; then
    OUTPUT="$OUTPUT-smp"
  fi
fi

if [ "$M$P" = "" ]; then :; else
  # Workaround for XP64 DWIMing PROCESSOR_ARCHITECTURE...
  PROCESSOR_ARCHITECTURE="`getntenv PROCESSOR_IDENTIFIER|cut '-d ' -f1`"

  # PROCESSOR_IDENTIFIER is typically something like:
  #   "ia64 Family 7 Model 1 Stepping 5, GenuineIntel"
  # or
  #   "x86 Family 6 Model 7 Stepping 3, GenuineIntel"

  if [ "$PROCESSOR_ARCHITECTURE" = "x86" ]; then
    PROCESSOR_ARCHITECTURE="i`getntenv PROCESSOR_LEVEL`86"
    if [ "$PROCESSOR_ARCHITECTURE" = "i86" ]; then
      # Probably not reached, but...
      PROCESSOR_ARCHITECTURE="i386"
    fi
  fi

  if [ "$M" = yes ]; then
    OUTPUT="$OUTPUT $PROCESSOR_ARCHITECTURE"
  fi
  
  if [ "$P" = yes ]; then
    OUTPUT="$OUTPUT $PROCESSOR_ARCHITECTURE"
  fi
fi

# Note: No quotes, so that we get rid of extra white space.
echo $OUTPUT

exit 0
