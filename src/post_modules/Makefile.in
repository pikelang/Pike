# $Id: Makefile.in,v 1.14 2004/05/01 12:53:44 mast Exp $

@make_variables@

MODULES=@subdirs@
MODULE_SEGMENTS=@MODULE_SEGMENTS@
MODULE_LINKOPTS=@MODULE_LINKOPTS@

all: linker_options modlist.h modlist_headers.h

$(MODULE_SEGMENTS) $(MODULE_LINKOPTS): modules

force:
	@:

$(MODULES) no : force
	@if [ "$@" = "no" ]; then :; else \
	  echo Making post_modules/$@; \
	  ( cd $@ && \
	    (  rm remake >/dev/null 2>&1 || : ) && \
	    ( $(MAKE) $(MAKE_FLAGS) || \
	      ( test -f remake && $(MAKE) $(MAKE_FLAGS) ) ) \
	  ) || exit $$?; \
	fi

modules: Makefile $(MODULES)

modlist.h: $(MODULE_SEGMENTS)
	( for a in $(MODULES) no ; do \
	    if [ "$$a" = "no" ]; then :; else \
	      cat $$a/modlist_segment; \
	    fi; \
	  done ) >modlist.h

modlist_headers.h: $(MODULE_SEGMENTS)
	( for a in $(MODULES) no ; do \
	    if [ "$$a" = "no" ]; then :; else \
	      cat $$a/modlist_segment; \
	    fi; \
	  done \
	) | sed -e 's/^.*{.*,\(.*\),\(.*\).*}.*$$/void \1(void),\2(void);/' >modlist_headers.h

linker_options: $(MODULE_LINKOPTS)
	( for a in $(MODULES) no ; do \
	    if [ "$$a" = "no" ]; then :; else \
	      cat $$a/linker_options; \
	    fi; \
	  done \
	) >linker_options

make_variables: $(make_variables_in) config.status
	CONFIG_FILES="make_variables:$(make_variables_in)" CONFIG_HEADERS="" ./config.status

Makefile: $(SRCDIR)/Makefile.in $(SRCDIR)/dependencies ./config.status
	CONFIG_FILES=Makefile CONFIG_HEADERS="" ./config.status
	touch remake
	@echo "Run make again" >&2
	@exit 1

$(SRCDIR)/configure: $(SRCDIR)/configure.in $(PIKE_SRC_DIR)/aclocal.m4
	cd $(SRCDIR) && $(PIKE_SRC_DIR)/run_autoconfig --no-recursion .

config.status: $(SRCDIR)/configure
	CFLAGS="$(REAL_CFLAGS)" LDFLAGS="$(REAL_LDFLAGS)" CPPFLAGS="$(REAL_CPPFLAGS)" BUILDDIR="$(TMP_BUILDDIR)" BINDIR="$(TMP_BINDIR)" PIKE_SRC_DIR="$(PIKE_SRC_DIR)" BUILD_BASE="$(BUILD_BASE)" ./config.status --recheck

depend: Makefile
	@for a in $(MODULES) no ; do \
	  if test "$$a" = "no"; then :; else \
	    ( cd $$a && { \
	      rm -f remake; \
	      ${MAKE} $(MAKE_FLAGS) depend || \
		if test -f remake; then ${MAKE} $(MAKE_FLAGS) depend; else exit $$?; fi; \
	    }); \
	  fi; \
	done

install:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a ; ${MAKE} $(MAKE_FLAGS) install ) ; \
	  fi; \
	done

clean_here:
	-rm -f linker_options modlist.h modlist_headers.h

clean: clean_here
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a ; ${MAKE} $(MAKE_FLAGS) clean ) ; \
	  fi; \
	done

spotless: clean_here
	-rm -f config.cache config.log config.status Makefile make_variables conftest.*
	-rm -f common_module_makefile dynamic_module_makefile static_module_makefile
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a ; ${MAKE} $(MAKE_FLAGS) spotless ) ; \
	  fi; \
	done

verify:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a ; \
	      echo verifying $$a ; \
	      ${MAKE} $(MAKE_FLAGS) verify \
	    ) || exit $$? ; \
	  fi; \
	done

verbose_verify:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a ; \
	      ${MAKE} $(MAKE_FLAGS) verbose_verify \
	    ) || exit $$? ; \
	  fi; \
	done

fdtestsuites:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    echo $$a ; \
	    $(TMP_BINDIR)/mktestsuite $(SRCDIR)/$$a/testsuite.in >$$a/testsuite -DSRCDIR=$(SRCDIR)/$$a || exit $$? ; \
	  fi; \
	done	

testsuites:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    (cd $$a && $(MAKE) testsuite) ; \
	  fi; \
	done

extra_tests:
	@for a in $(MODULES) no ; do \
	  if [ "$$a" = "no" ]; then :; else \
	    ( cd $$a && \
	      ${MAKE} $(MAKE_FLAGS) extra_tests \
	    ) || exit $$? ; \
	  fi; \
	done


@dependencies@
